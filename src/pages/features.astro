---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import Phone3D from '../components/Phone3D.astro';
import ScrollyFeature from '../components/ScrollyFeature.astro';
---

<Layout title="DocSera - مميزات التطبيق">
	<Navbar />
    
    <main class="scrolly-wrapper">
        
        <!-- STICKY CONTAINER FOR 3D PHONE -->
        <div class="sticky-graphic">
            <div class="phone-container">
                <Phone3D src="/images/raw/home.webp" alt="App Screen" id="hero-phone" />
            </div>
            
            <!-- Dynamic Title that fades out -->
            <div class="hero-overlay" id="hero-title">
                <h1>تطبيق متكامل<br>بين يديك</h1>
                <p>مرر لأسفل لاكتشاف المميزات</p>
                <div class="scroll-ind">↓</div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="content-stream">
            
            <!-- SPACER FOR HERO ZOOM EFFECT -->
            <div class="scroll-spacer" id="zoom-trigger"></div>

            <ScrollyFeature 
                step="01" 
                title="لوحة تحكم شاملة" 
                description="كل ما تحتاجه في شاشة واحدة. مواعيدك القادمة، وتنبيهات الأدوية."
                align="right"
                imgTarget="/images/raw/home.webp"
            />

            <ScrollyFeature 
                step="02" 
                title="بحث ذكي" 
                description="خريطة تفاعلية وقائمة ذكية للعثور على أقرب العيادات إليك."
                align="left"
                imgTarget="/images/raw/map.webp"
            />

            <ScrollyFeature 
                step="03" 
                title="ملفات الأطباء" 
                description="تعرف على مؤهلات الطبيب وتقييماته قبل الحجز."
                align="right"
                imgTarget="/images/raw/doctor_profile.webp"
            />

            <ScrollyFeature 
                step="04" 
                title="حجز فوري" 
                description="احجز موعدك بضغطة زر مع تأكيد فوري."
                align="left"
                imgTarget="/images/raw/booking_1.webp"
            />

            <ScrollyFeature 
                step="05" 
                title="محادثة آمنة" 
                description="تواصل مع طبيبك مباشرة عبر الشات الآمن."
                align="right"
                imgTarget="/images/raw/chat.webp"
            />

            <ScrollyFeature 
                step="06" 
                title="إدارة العائلة" 
                description="أضف أفراد عائلتك وائدر ملفاتهم الطبية."
                align="left"
                imgTarget="/images/raw/family.webp"
            />
            
            <!-- Padding for end -->
            <div style="height: 50vh;"></div>

        </div>

    </main>
	<Footer />
</Layout>

<script>
    const phone = document.getElementById('hero-phone');
    const pivot = phone?.querySelector('.phone-pivot') as HTMLElement;
    const screenImg = phone?.querySelector('.screen-img') as HTMLImageElement;
    const heroTitle = document.getElementById('hero-title');
    const sections = document.querySelectorAll('.scrolly-section');
    const container = phone?.closest('.phone-container') as HTMLElement;
    
    // Config
    const HERO_SCROLL_HEIGHT = 800; // Pixels to transition from Hero to Standard
    const PHONE_BASE_HEIGHT = 1344; // Scalling 2x for 4K quality

    // Cache Viewport Dimensions (Stability Fix)
    let vpW = window.innerWidth;
    let vpH = window.innerHeight;

    function updateDimensions() {
        const newW = window.innerWidth;
        // Only update height if width changes (orientation) or if on Desktop
        // This prevents the phone from "Jumping" when Mobile URL bar hides/shows
        if (newW !== vpW || newW >= 768) {
            vpW = newW;
            vpH = window.innerHeight;
        }
        update();
    }

    function update() {
        // 1. READS (Collect all metrics first)
        const scrolled = window.scrollY;
        const isMobile = vpW < 768;
        
        // Batch Section Reads (Prevent Layout Thrashing on Mobile)
        let sectionUpdates: {el: HTMLElement, opacity: number}[] = [];
        if (isMobile) {
             const centerPoint = vpH * 0.6;
             const endPoint = vpH * 0.3;
             
             sections.forEach(sec => {
                 const rect = sec.getBoundingClientRect(); // READ
                 const content = sec.querySelector('.content') as HTMLElement;
                 if(!content) return;
                 
                 let op = 1;
                 if (rect.top < centerPoint) {
                     op = (rect.top - endPoint) / (centerPoint - endPoint);
                     if (op < 0) op = 0;
                     if (op > 1) op = 1;
                 }
                 sectionUpdates.push({ el: content, opacity: op });
             });
        }

        // 2. CALCULATIONS (Pure Math)
        const targetPercent = isMobile ? 0.58 : 0.82;
        const targetHeight = vpH * targetPercent; 
        const targetScale = targetHeight / PHONE_BASE_HEIGHT;
        const startScaleMultiplier = isMobile ? 1.5 : 2.1;
        const startScale = Math.max(isMobile ? 0.75 : 1.25, targetScale * startScaleMultiplier);

        let progress = scrolled / HERO_SCROLL_HEIGHT;
        if (progress > 1) progress = 1;
        
        let currentScale = startScale - (progress * (startScale - targetScale));
        
        // Calculate Translation
        const halfHeight = PHONE_BASE_HEIGHT / 2;
        const startVisualTopOffset = halfHeight - (halfHeight * startScale);
        
        // Start: 55% VH
        const startTargetTop = vpH * 0.55;
        const zoomTranslateY = startTargetTop - startVisualTopOffset;

        // End Strategy
        const targetVisualTopOffset = halfHeight - (halfHeight * targetScale);
        let restTranslateY = 0;
        if (isMobile) {
            restTranslateY = (vpH * 0.15) - targetVisualTopOffset;
        } else {
            restTranslateY = (vpH * 0.10) - targetVisualTopOffset;
        }

        const currentTranslateY = zoomTranslateY - (progress * (zoomTranslateY - restTranslateY));

        // Rotation
        let rotY = 0, rotX = 0;
        if (pivot && !isMobile) {
             rotY = Math.sin(scrolled / 500) * 12; 
             rotX = Math.cos(scrolled / 600) * 4; 
        }

        // Title Opacity
        let titleOp = Math.max(0, 1 - (scrolled / 400));


        // 3. WRITES (Apply all styles at once)
        if (container) {
            container.style.transform = `translateY(${currentTranslateY}px) scale(${currentScale})`;
        }
        
        if (pivot) {
             pivot.style.transform = `rotateY(${rotY}deg) rotateX(${rotX}deg)`;
        }

        if (heroTitle) {
            heroTitle.style.opacity = titleOp.toString();
            heroTitle.style.pointerEvents = titleOp <= 0 ? 'none' : 'auto';
        }

        if (isMobile) {
            sectionUpdates.forEach(item => {
                item.el.style.opacity = item.opacity.toString();
                const s = 0.9 + (0.1 * item.opacity);
                item.el.style.transform = `scale(${s})`;
            });
        }
    }

    // Init
    updateDimensions();

    // Scroll Loop
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                update();
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });
    
    // Optimized Resize
    window.addEventListener('resize', updateDimensions);


    // 3. OBSERVER FOR CONTENT SWITCHING
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Highlight text
                document.querySelectorAll('.scrolly-section').forEach(el => el.classList.remove('active'));
                entry.target.classList.add('active');

                // Switch Image
                const targetImg = entry.target.getAttribute('data-img');
                if (targetImg && screenImg && screenImg.getAttribute('src') !== targetImg) {
                    screenImg.style.opacity = '0';
                    setTimeout(() => {
                        screenImg.src = targetImg;
                        screenImg.style.opacity = '1';
                    }, 200);
                }
            }
        });
    }, { threshold: 0.5 }); 

    sections.forEach(sec => observer.observe(sec));
    
    if(screenImg) {
        screenImg.style.transition = 'opacity 0.3s ease';
    }

</script>

<style>
    .scrolly-wrapper {
        position: relative;
    }

    .sticky-graphic {
        position: sticky;
        top: 0;
        height: 100vh;
        width: 100%;
        overflow: hidden;
        display: flex;
        align-items: flex-start; 
        justify-content: center;
        direction: ltr; /* Force LTR to ensure true center even with overflow */
        z-index: 1; 
        pointer-events: none;
    }

    .phone-container {
        /* Fix: Relative + Flex + LTR Parent = Perfect Centering */
        position: relative;
        left: auto; top: auto; right: auto; margin: 0;
        width: 620px;
        height: 1344px;
        flex-shrink: 0;
        transform-origin: center center;
        transition: transform 0.1s linear; 
    }

    .hero-overlay {
        position: absolute;
        top: 15%; /* Move title to top to avoid covering the phone */
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        z-index: 10;
        transition: opacity 0.5s;
        width: 100%;
        pointer-events: none;
    }
    
    .hero-overlay h1 {
        font-size: clamp(3rem, 6vw, 5rem);
        line-height: 1.1;
        color: var(--c-main-dark);
        margin-bottom: 1rem;
        /* Clean text without heavy box */
        text-shadow: 0 4px 12px rgba(255,255,255,0.8); 
    }
    
    .scroll-ind {
        font-size: 2rem;
        animation: bounce 2s infinite;
    }

    .content-stream {
        position: relative;
        z-index: 2; /* In front of sticky graphic? */
        /* Actually, we want text to float OVER the phone if centered, or beside it. */
        /* For "Apple Style", often text is Over or Side. */
        /* Using Mix-Blend-Mode or distinct layout. */
        /* Let's put content-stream on top, but spaced out so phone is visible */
        pointer-events: none; /* Let content be clickable, but not block scroll */
    }

    /* Re-enable pointer events for text */
    :global(.scrolly-section .content) {
        pointer-events: auto;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: opacity 0.1s linear, transform 0.1s linear; /* Smooth fade/scale */
    }
    
    .scroll-spacer {
        height: 100vh; /* First screen is mostly empty for Hero Zoom */
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(10px); }
    }

    /* MOBILE ADJUSTMENTS */
    @media (max-width: 768px) {
        /* On mobile, keep the sticky graphic visible but scale logic handles size */
        .sticky-graphic { 
            /* No opacity fade! Keep it visible as per user request */
            opacity: 1; 
        }
        
        .hero-overlay h1 { font-size: 2.5rem; } /* Smaller header */
        
        /* Adjust text cards to be bottom sheets or smaller */
        :global(.scrolly-section) {
            justify-content: flex-end; /* Push text to bottom */
            padding-bottom: 150px; /* Space from bottom */
        }
        :global(.scrolly-section .content) {
            max-width: 90%;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            /* Initial smaller state is handled by JS but set base here */
            font-size: 0.9em;
            padding: 20px;
        }
    }
</style>
