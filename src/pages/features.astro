---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import Phone3D from '../components/Phone3D.astro';
import ScrollyFeature from '../components/ScrollyFeature.astro';
---

<Layout title="DocSera - مميزات التطبيق">
	<Navbar />
    
    <main class="scrolly-wrapper">
        
        <!-- STICKY CONTAINER FOR 3D PHONE -->
        <div class="sticky-graphic">
            <div class="phone-container">
                <Phone3D src="/images/raw/home.png" alt="App Screen" id="hero-phone" />
            </div>
            
            <!-- Dynamic Title that fades out -->
            <div class="hero-overlay" id="hero-title">
                <h1>تطبيق متكامل<br>بين يديك</h1>
                <p>مرر لأسفل لاكتشاف المميزات</p>
                <div class="scroll-ind">↓</div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="content-stream">
            
            <!-- SPACER FOR HERO ZOOM EFFECT -->
            <div class="scroll-spacer" id="zoom-trigger"></div>

            <ScrollyFeature 
                step="01" 
                title="لوحة تحكم شاملة" 
                description="كل ما تحتاجه في شاشة واحدة. مواعيدك القادمة، وتنبيهات الأدوية."
                align="right"
                imgTarget="/images/raw/home.png"
            />

            <ScrollyFeature 
                step="02" 
                title="بحث ذكي" 
                description="خريطة تفاعلية وقائمة ذكية للعثور على أقرب العيادات إليك."
                align="left"
                imgTarget="/images/raw/map.png"
            />

            <ScrollyFeature 
                step="03" 
                title="ملفات الأطباء" 
                description="تعرف على مؤهلات الطبيب وتقييماته قبل الحجز."
                align="right"
                imgTarget="/images/raw/doctor_profile.png"
            />

            <ScrollyFeature 
                step="04" 
                title="حجز فوري" 
                description="احجز موعدك بضغطة زر مع تأكيد فوري."
                align="left"
                imgTarget="/images/raw/booking_1.png"
            />

            <ScrollyFeature 
                step="05" 
                title="محادثة آمنة" 
                description="تواصل مع طبيبك مباشرة عبر الشات الآمن."
                align="right"
                imgTarget="/images/raw/chat.png"
            />

            <ScrollyFeature 
                step="06" 
                title="إدارة العائلة" 
                description="أضف أفراد عائلتك وائدر ملفاتهم الطبية."
                align="left"
                imgTarget="/images/raw/family.png"
            />
            
            <!-- Padding for end -->
            <div style="height: 50vh;"></div>

        </div>

    </main>
	<Footer />
</Layout>

<script>
    const phone = document.getElementById('hero-phone');
    const pivot = phone?.querySelector('.phone-pivot') as HTMLElement;
    const screenImg = phone?.querySelector('.screen-img') as HTMLImageElement;
    const heroTitle = document.getElementById('hero-title');
    const sections = document.querySelectorAll('.scrolly-section');
    const container = phone?.closest('.phone-container') as HTMLElement;
    
    // Config
    const HERO_SCROLL_HEIGHT = 800; // Pixels to transition from Hero to Standard
    const PHONE_BASE_HEIGHT = 1344; // Scalling 2x for 4K quality

    function update() {
        const scrolled = window.scrollY;
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        const isMobile = viewportWidth < 768;

        // Calculate Target Scale (Standard Size)
        // Desktop: 82% of screen. Mobile: 58% of screen (User requested bigger than 50%)
        const targetPercent = isMobile ? 0.58 : 0.82;
        const targetHeight = viewportHeight * targetPercent; 
        const targetScale = targetHeight / PHONE_BASE_HEIGHT;
        
        // Hero Zoom Start Scale
        // Desktop: 2.1x target. Mobile: 1.5x target (less extreme zoom)
        const startScaleMultiplier = isMobile ? 1.5 : 2.1;
        // Adjusted floors for 2x resolution (Base Height 1344px)
        // Old was 1.5/2.5 on 672px. New is 0.75/1.25 on 1344px.
        const startScale = Math.max(isMobile ? 0.75 : 1.25, targetScale * startScaleMultiplier);

        // 1. HERO ZOOM LOGIC
        let progress = scrolled / HERO_SCROLL_HEIGHT;
        if (progress > 1) progress = 1;
        
        let currentScale = startScale - (progress * (startScale - targetScale));

        // Opacity of Hero Title
        let titleOp = 1 - (scrolled / 400);
        if (heroTitle) {
            heroTitle.style.opacity = Math.max(0, titleOp).toString();
            heroTitle.style.pointerEvents = titleOp <= 0 ? 'none' : 'auto';
        }

        // AUTO-CENTERING THE TOP WHEN ZOOMED
        // User Request: "Make it 65%" (Visual Top at 65% of viewport)
        // Formula: TranslateY = (ScaledHeight / 2) + (ViewportHeight * 0.15)
        const scaledHeight = PHONE_BASE_HEIGHT * startScale;
        const zoomTranslateY = (scaledHeight / 2) + (viewportHeight * 0.15);

        // RESTING POSITION (Standard State)
        let restTranslateY = 0;
        
        if (isMobile) {
            // MOBILE: Anchor Top to 15% of Viewport
            // Container is Centered (50%). Phone Top is at (50% - Height/2).
            // We want Top at 15%.
            // Shift = TargetTop - CurrentTop
            // Shift = 0.15VH - (0.50VH - Height/2)
            // Shift = -0.35VH + Height/2
            restTranslateY = -(viewportHeight * 0.35) + (targetHeight / 2);
        } else {
            // DESKTOP: Push down 5% (Total top at ~14%)
             restTranslateY = viewportHeight * 0.05;
        }

        // Interpolate Translation
        const currentTranslateY = zoomTranslateY - (progress * (zoomTranslateY - restTranslateY));

        // Apply Transform to Container
        if (container) {
            container.style.transform = `translateY(${currentTranslateY}px) scale(${currentScale})`;
        }

        // 2. ROTATION LOGIC
        const rotationY = Math.sin(scrolled / 500) * 12; 
        const rotationX = Math.cos(scrolled / 600) * 4; 

        if (pivot) {
             pivot.style.transform = `rotateY(${rotationY}deg) rotateX(${rotationX}deg)`;
        }
        // 3. FADE OUT TEXT CARDS ON SCROLL (Mobile Polish)
        // If a card gets too high (approaching the phone), fade it out.
        if (isMobile) {
            sections.forEach(sec => {
                const rect = sec.getBoundingClientRect();
                const content = sec.querySelector('.content') as HTMLElement;
                if (!content) return;
                
                // If top of section is at 50% of viewport, it's centered (Opacity 1).
                // If it goes up to 30%, it should fade to 0. (Phone is at top).
                const centerPoint = viewportHeight * 0.6; // Start fading when above this
                const endPoint = viewportHeight * 0.3; // Fully transparent here
                
                let opacity = 1;
                if (rect.top < centerPoint) {
                    // Map distance [endPoint, centerPoint] to [0, 1]
                    opacity = (rect.top - endPoint) / (centerPoint - endPoint);
                    if (opacity < 0) opacity = 0;
                    if (opacity > 1) opacity = 1;
                }
                
                // Also fade in from bottom? (Optional, but user said "disappear when scrolling before reaching mobile")
                // So focusing on the Top Fade.
                content.style.opacity = opacity.toString();
                // Scale slightly for effect?
                const scale = 0.9 + (0.1 * opacity); // 0.9 to 1.0
                content.style.transform = `scale(${scale})`;
            });
        }
    }

    // Run immediately to set initial state (Fixes "Small Phone" glitch)
    update();
    
    // Run on scroll
    window.addEventListener('scroll', update, { passive: true });
    // Run on resize to recalculate target scale
    window.addEventListener('resize', update);


    // 3. OBSERVER FOR CONTENT SWITCHING
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Highlight text
                document.querySelectorAll('.scrolly-section').forEach(el => el.classList.remove('active'));
                entry.target.classList.add('active');

                // Switch Image
                const targetImg = entry.target.getAttribute('data-img');
                if (targetImg && screenImg && screenImg.getAttribute('src') !== targetImg) {
                    screenImg.style.opacity = '0';
                    setTimeout(() => {
                        screenImg.src = targetImg;
                        screenImg.style.opacity = '1';
                    }, 200);
                }
            }
        });
    }, { threshold: 0.5 }); 

    sections.forEach(sec => observer.observe(sec));
    
    if(screenImg) {
        screenImg.style.transition = 'opacity 0.3s ease';
    }

</script>

<style>
    .scrolly-wrapper {
        position: relative;
    }

    .sticky-graphic {
        position: sticky;
        top: 0;
        height: 100vh;
        width: 100%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1; /* Behind content */
        pointer-events: none; /* Let clicks pass to content? */
    }

    .phone-container {
        /* Will be transformed by JS */
        transform-origin: center center;
        transition: transform 0.1s linear; /* Smooth sync */
    }

    .hero-overlay {
        position: absolute;
        top: 15%; /* Move title to top to avoid covering the phone */
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        z-index: 10;
        transition: opacity 0.5s;
        width: 100%;
        pointer-events: none;
    }
    
    .hero-overlay h1 {
        font-size: clamp(3rem, 6vw, 5rem);
        line-height: 1.1;
        color: var(--c-main-dark);
        margin-bottom: 1rem;
        /* Clean text without heavy box */
        text-shadow: 0 4px 12px rgba(255,255,255,0.8); 
    }
    
    .scroll-ind {
        font-size: 2rem;
        animation: bounce 2s infinite;
    }

    .content-stream {
        position: relative;
        z-index: 2; /* In front of sticky graphic? */
        /* Actually, we want text to float OVER the phone if centered, or beside it. */
        /* For "Apple Style", often text is Over or Side. */
        /* Using Mix-Blend-Mode or distinct layout. */
        /* Let's put content-stream on top, but spaced out so phone is visible */
        pointer-events: none; /* Let content be clickable, but not block scroll */
    }

    /* Re-enable pointer events for text */
    :global(.scrolly-section .content) {
        pointer-events: auto;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: opacity 0.1s linear, transform 0.1s linear; /* Smooth fade/scale */
    }
    
    .scroll-spacer {
        height: 100vh; /* First screen is mostly empty for Hero Zoom */
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(10px); }
    }

    /* MOBILE ADJUSTMENTS */
    @media (max-width: 768px) {
        /* On mobile, keep the sticky graphic visible but scale logic handles size */
        .sticky-graphic { 
            /* No opacity fade! Keep it visible as per user request */
            opacity: 1; 
        }
        
        .hero-overlay h1 { font-size: 2.5rem; } /* Smaller header */
        
        /* Adjust text cards to be bottom sheets or smaller */
        :global(.scrolly-section) {
            justify-content: flex-end; /* Push text to bottom */
            padding-bottom: 150px; /* Space from bottom */
        }
        :global(.scrolly-section .content) {
            max-width: 90%;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            /* Initial smaller state is handled by JS but set base here */
            font-size: 0.9em;
            padding: 20px;
        }
    }
</style>
