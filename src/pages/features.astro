---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import Phone3D from '../components/Phone3D.astro';
---

<Layout title="DocSera - عن التطبيق">
	<Navbar />
    
    <main class="scrolly-wrapper">
        
        <!-- STICKY CONTAINER FOR 3D PHONE -->
        <div class="sticky-graphic">
            <div class="phone-container">
                <Phone3D id="hero-phone">
                    <div class="screen-stack">
                        <!-- Homepage (Base) -->
                        <img src="/images/raw/home.webp" class="screen-layer active" id="layer-home" alt="Home" />
                        
                        <!-- Search Sequence -->
                        <img src="/images/screenshots/search_specialty.webp" class="screen-layer" id="layer-search-1" alt="Specialty" />
                        <img src="/images/screenshots/search_location.webp" class="screen-layer" id="layer-search-2" alt="Location" />
                        <img src="/images/raw/search_list.webp" class="screen-layer" id="layer-search-3" alt="Results" />
                        <img src="/images/raw/map.webp" class="screen-layer" id="layer-search-4" alt="Map" />

                        <!-- Doctor Profile Scroll Container -->
                        <div class="screen-layer scroll-container" id="layer-doctor-scroll">
                             <div class="scroll-inner">
                                <img src="/images/screenshots/doctor_profile_full.webp" class="scroll-img full" alt="Full Profile" />
                             </div>
                        </div>

                        <!-- NEW: Booking Sequence (5 steps) -->
                        <img src="/images/screenshots/booking_3.webp" class="screen-layer" id="layer-booking-1" alt="Booking Patient" />
                        <img src="/images/screenshots/booking_2.webp" class="screen-layer" id="layer-booking-2" alt="Booking Reason" />
                        <img src="/images/screenshots/booking_1.webp" class="screen-layer" id="layer-booking-3" alt="Booking Time" />
                        <img src="/images/screenshots/booking_4.webp" class="screen-layer" id="layer-booking-4" alt="Booking Confirm" />
                        <img src="/images/screenshots/booking_5.webp" class="screen-layer" id="layer-booking-5" alt="Booking Success" />

                        <!-- Appointments Sequence -->
                        <img src="/images/screenshots/appointments_list.webp" class="screen-layer" id="layer-appointments-1" alt="Appointments List" />
                        <img src="/images/screenshots/appointment_details.webp" class="screen-layer" id="layer-appointments-2" alt="Appointment Details" />

                        <!-- NEW: Messaging Sequence (Step 6) -->
                        <img src="/images/screenshots/messages_list.webp" class="screen-layer" id="layer-messages-1" alt="Messages List" />
                        <img src="/images/screenshots/conversation.webp" class="screen-layer" id="layer-messages-2" alt="Conversation" />

                        <!-- QR Code -->
                        <img src="/images/screenshots/doctor_qr.webp" class="screen-layer" id="layer-qr" alt="QR" />
                    </div>
                </Phone3D>
            </div>
            
            <!-- Dynamic Title that fades out -->
            <div class="hero-overlay" id="hero-title">
                <h1>تطبيق متكامل<br>بين يديك</h1>
                <p>كل ما تحتاجه لرعاية صحية أفضل</p>
                <div class="scroll-ind">↓</div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="content-stream">
            
            <!-- SPACER FOR HERO ZOOM -->
            <div class="section-spacer" id="start-trigger"></div>

            <!-- SECTION 1: HOMEPAGE (Search, Favs, Nav, Banners) -->
            <div class="feature-block active" data-layer="layer-home">
                <div class="content-card right with-number" data-step="01">
                    <h2>الرئيسية الشاملة</h2>
                    <p>واجهة متكاملة تمنحك الوصول السريع لكل ما تحتاجه:</p>
                    <ul>
                        <li><strong>البحث المتقدم:</strong> ابحث عن الأطباء بسهولة.</li>
                        <li><strong>أطبائي:</strong> قائمة بأطبائك المفضلين للوصول السريع.</li>
                        <li><strong>دليلك الطبي:</strong> مقالات ونصائح طبية موثوقة.</li>
                        <li><strong>الإعلانات والعروض:</strong> آخر العروض الطبية والباقات.</li>
                    </ul>
                </div>
            </div>

            <!-- SECTION 2: SEARCH FLOW (Sequence) -->
            <div class="feature-sequence" id="search-sequence">
                <div class="sticky-note left with-number" data-step="02">
                    <h2>بحث ذكي ومتطور</h2>
                    <p>نقدم لك خيارات بحث مرنة تناسب احتياجاتك:</p>
                    <ul class="clean-list">
                        <li class="active-item" data-target="layer-search-1">1. اختر التخصص الطبي</li>
                        <li data-target="layer-search-2">2. حدد الموقع الأقرب إليك</li>
                        <li data-target="layer-search-3">3. تصفح النتائج مع الفلترة</li>
                        <li data-target="layer-search-4">4. استعرض العيادات على الخريطة</li>
                    </ul>
                </div>
                <!-- Invisible triggers for scroll-based switching -->
                <div class="seq-trigger" data-layer="layer-search-1"></div>
                <div class="seq-trigger" data-layer="layer-search-2"></div>
                <div class="seq-trigger" data-layer="layer-search-3"></div>
                <div class="seq-trigger" data-layer="layer-search-4"></div>
            </div>

            <!-- SECTION 3: DOCTOR PROFILE (Scroll Effect + QR) -->
            <div class="feature-sequence" id="doctor-sequence">
                <div class="sticky-note right with-number" data-step="03">
                    <h2>ملف الطبيب الشخصي</h2>
                    <p>تعرف على طبيبك قبل الحجز. استعرض المؤهلات، الخبرات، وأوقات الدوام.</p>
                    <p class="sub-note">يمكنك أيضاً مشاركة الملف عبر QR Code لسهولة الوصول.</p>
                </div>
                
                <!-- Trigger for Profile Top -->
                <div class="seq-trigger" data-layer="layer-doctor-scroll" data-action="reset-scroll"></div>
                
                <!-- Trigger for Scroll Animation -->
                <div class="seq-trigger long" data-layer="layer-doctor-scroll" data-action="animate-scroll"></div>
                
                <!-- Trigger for QR -->
                <div class="seq-trigger" data-layer="layer-qr"></div>
            </div>

            <!-- SECTION 4: BOOKING FLOW (Sequence) -->
            <div class="feature-sequence" id="booking-sequence">
                <div class="sticky-note left with-number" data-step="04">
                    <h2 class="rtl">حجز المواعيد بسهولة</h2>
                    <p>خطوات بسيطة وسريعة لحجز موعدك مع طبيبك المفضل:</p>
                    <ul class="clean-list">
                        <li class="active-item" data-target="layer-booking-1">1. اختر المريض (أنت أو أحد أفراد عائلتك)</li>
                        <li data-target="layer-booking-2">2. حدد سبب الزيارة</li>
                        <li data-target="layer-booking-3">3. اختر الوقت والتاريخ المناسب</li>
                        <li data-target="layer-booking-4">4. راجع تفاصيل الحجز وتأكيده</li>
                        <li data-target="layer-booking-5">5. تم الحجز بنجاح!</li>
                    </ul>
                </div>
                <!-- Triggers -->
                <div class="seq-trigger" data-layer="layer-booking-1"></div>
                <div class="seq-trigger" data-layer="layer-booking-2"></div>
                <div class="seq-trigger" data-layer="layer-booking-3"></div>
                <div class="seq-trigger" data-layer="layer-booking-4"></div>
                <div class="seq-trigger" data-layer="layer-booking-5"></div>
            </div>

            <!-- SECTION 5: APPOINTMENTS (Sequence) -->
            <div class="feature-sequence" id="appointments-sequence">
                <div class="sticky-note right with-number" data-step="05">
                    <h2>إدارة مواعيدك الشخصية</h2>
                    <p>تحكم كامل في مواعيدك الطبية بكل سهولة ويسر:</p>
                    <ul class="clean-list">
                        <li class="active-item" data-target="layer-appointments-1">1. استعرض المواعيد القادمة والسابقة</li>
                        <li data-target="layer-appointments-2">2. تفاصيل دقيقة لكل موعد (الوقت، الطبيب، الحالة)</li>
                    </ul>
                </div>
                <!-- Triggers -->
                <div class="seq-trigger" data-layer="layer-appointments-1"></div>
                <div class="seq-trigger" data-layer="layer-appointments-2"></div>
            </div>

            <!-- SECTION 6: MESSAGING & CONVERSATION (Sequence) -->
            <div class="feature-sequence" id="messages-sequence">
                <div class="sticky-note left with-number" data-step="06">
                    <h2>تواصل مباشر مع طبيبك</h2>
                    <p>منصة محادثة متطورة للتواصل الفعال والآمن:</p>
                    <ul class="clean-list">
                        <li class="active-item" data-target="layer-messages-1">1. قائمة المحادثات: تواصل باسمك أو نيابة عن عائلتك</li>
                        <li data-target="layer-messages-2">2. محادثة غنية: أرسل صور، ملفات PDF، ورسائل صوتية بكل سهولة</li>
                    </ul>
                    <p class="sub-note" style="margin-top: 20px; font-size: 0.95rem; opacity: 0.8;">
                        ميزة "التحدث نيابة عن" تتيح لك إدارة الملفات الطبية لأطفالك أو كبار العائلة والتواصل مع الطبيب بخصوص حالتهم مباشرة من حسابك.
                    </p>
                </div>
                <!-- Triggers -->
                <div class="seq-trigger" data-layer="layer-messages-1"></div>
                <div class="seq-trigger" data-layer="layer-messages-2"></div>
            </div>

            <div style="height: 50vh;"></div>

        </div>

    </main>
	<Footer />
</Layout>

<script>
    // --- 3D Phone Motion Logic (Same as before but refined) ---
    const phone = document.getElementById('hero-phone');
    const pivot = phone?.querySelector('.phone-pivot') as HTMLElement;
    const heroTitle = document.getElementById('hero-title');
    const container = phone?.closest('.phone-container') as HTMLElement;
    
    // Layers
    const layers = document.querySelectorAll('.screen-layer');
    const triggers = document.querySelectorAll('.seq-trigger, .feature-block');
    const scrollInner = document.querySelector('.scroll-inner') as HTMLElement;
    const scrollContainer = document.querySelector('.scroll-container') as HTMLElement;

    // Viewport Config
    let vpW = window.innerWidth;
    let vpH = window.innerHeight;
    const PHONE_BASE_HEIGHT = 1344;
    
    function updateDimensions() {
        vpW = window.innerWidth;
        vpH = window.innerHeight;
        updatePhoneTransform();
    }

    function updatePhoneTransform() {
        const scrolled = window.scrollY;
        const isMobile = vpW < 1024;
        
        // --- 1. Zoom Logic for Hero ---
        const HERO_HEIGHT = 800;
        let progress = Math.min(1, scrolled / HERO_HEIGHT);
        
        const targetPercent = isMobile ? 0.58 : 0.82;
        const targetScale = (vpH * targetPercent) / PHONE_BASE_HEIGHT;
        const startScaleMultiplier = isMobile ? 1.5 : 2.1;
        const startScale = Math.max(isMobile ? 0.75 : 1.25, targetScale * startScaleMultiplier);
        
        const currentScale = startScale - (progress * (startScale - targetScale));
        
        // Translation Logic
        const halfHeight = PHONE_BASE_HEIGHT / 2;
        const startVisualTopOffset = halfHeight - (halfHeight * startScale);
        const startTargetTop = vpH * 0.65;
        const startY = startTargetTop - startVisualTopOffset;

        const targetVisualTopOffset = halfHeight - (halfHeight * targetScale);
        const endY = (vpH * (isMobile ? 0.15 : 0.10)) - targetVisualTopOffset;
        
        const currentY = startY - (progress * (startY - endY));

        if (container) {
            const transform = isMobile 
                ? `translateX(-50%) translateY(${currentY}px) scale(${currentScale})`
                : `translateY(${currentY}px) scale(${currentScale})`;
            container.style.transform = transform;
        }

        // Rotation
        if (pivot && !isMobile) {
             const rotY = Math.sin(scrolled / 500) * 12; 
             const rotX = Math.cos(scrolled / 600) * 4; 
             pivot.style.transform = `rotateY(${rotY}deg) rotateX(${rotX}deg)`;
        }

        // Title Fade
        if (heroTitle) {
            const op = Math.max(0, 1 - (scrolled / 400));
            heroTitle.style.opacity = op.toString();
            heroTitle.style.pointerEvents = op <= 0 ? 'none' : 'auto';
        }
    }

    // --- 2. Scroll Interaction (Layer Switching) ---
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const targetId = entry.target.getAttribute('data-layer');
                const action = entry.target.getAttribute('data-action');

                // 1. Switch Layer
                if (targetId) {
                    layers.forEach(l => l.classList.remove('active'));
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) targetEl.classList.add('active');
                    
                    // Highlight list items if in search sequence
                    if (targetId.includes('search')) {
                         document.querySelectorAll('#search-sequence .clean-list li').forEach(li => {
                             li.classList.toggle('active-item', li.getAttribute('data-target') === targetId);
                         });
                    }
                    // Highlight list items if in booking sequence
                    if (targetId.includes('booking')) {
                         document.querySelectorAll('#booking-sequence .clean-list li').forEach(li => {
                             li.classList.toggle('active-item', li.getAttribute('data-target') === targetId);
                         });
                    }
                    // Highlight list items if in appointments sequence
                    if (targetId.includes('appointments')) {
                         document.querySelectorAll('#appointments-sequence .clean-list li').forEach(li => {
                             li.classList.toggle('active-item', li.getAttribute('data-target') === targetId);
                         });
                    }
                    // Highlight list items if in messages sequence
                    if (targetId.includes('messages')) {
                         document.querySelectorAll('#messages-sequence .clean-list li').forEach(li => {
                             li.classList.toggle('active-item', li.getAttribute('data-target') === targetId);
                         });
                    }
                }

                // 2. Handle Special Actions (Doctor Scroll)
                if (targetId === 'layer-doctor-scroll' && scrollInner) {
                    if (action === 'animate-scroll') {
                        // Calculate scroll distance (Content Height - Viewport Height)
                        const contentHeight = scrollInner.scrollHeight;
                        const viewportHeight = scrollInner.parentElement?.clientHeight || 0;
                        const scrollDist = contentHeight - viewportHeight;
                        
                        if (scrollDist > 0) {
                            scrollInner.style.transform = `translateY(-${scrollDist}px)`;
                        }
                    } else {
                        scrollInner.style.transform = 'translateY(0)'; // Reset to top
                    }
                }
            }
        });
    }, { 
        threshold: 0.5,
        rootMargin: "-10% 0px -10% 0px"
    });

    triggers.forEach(t => observer.observe(t));

    // Loop
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updatePhoneTransform();
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });
    window.addEventListener('resize', updateDimensions);
    updateDimensions();

</script>

<style>
    .scrolly-wrapper { position: relative; }
    
    /* Sticky Container */
    .sticky-graphic {
        position: sticky; top: 0; height: 100vh;
        width: 100%; overflow: hidden;
        display: flex; justify-content: center;
        z-index: 1; pointer-events: none;
        direction: ltr;
    }
    
    .phone-container {
        position: relative;
        width: 620px; height: 1344px;
        flex-shrink: 0;
        transform-origin: center center;
        will-change: transform;
        transform: translateZ(0); 
    }
    
    @media (max-width: 1024px) {
        .phone-container { position: absolute; left: 50%; transform: translateX(-50%); }
    }

    /* Hero Overlay */
    .hero-overlay {
        position: absolute; top: 15%; left: 50%;
        transform: translateX(-50%); text-align: center;
        z-index: 10; width: 100%;
    }
    .hero-overlay h1 {
        font-size: clamp(3rem, 6vw, 5rem);
        color: var(--c-main-dark);
        margin-bottom: 1rem;
        text-shadow: 0 10px 30px rgba(255,255,255,0.9);
    }
    .scroll-ind { font-size: 2rem; animation: bounce 2s infinite; }

    /* Screen Stack Logic */
    .screen-stack {
        position: relative; width: 100%; height: 100%;
        background: black;
    }
    .screen-layer {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        object-fit: cover; object-position: top;
        opacity: 0;
        transition: opacity 0.4s ease; /* Fast switch */
        z-index: 1;
    }
    .screen-layer.active { opacity: 1; z-index: 2; }

    /* Doctor Scroll Special Layer */
    .scroll-container { overflow: hidden; }
    .scroll-inner {
        width: 100%; height: auto; /* Allow content to define height */
        display: block; 
        transition: transform 2.0s cubic-bezier(0.45, 0, 0.55, 1); /* Smooth elegant scroll */
        will-change: transform;
    }
    .scroll-img.full { width: 100%; height: auto; display: block; }

    /* Content Stream */
    .content-stream { position: relative; z-index: 5; pointer-events: none; }
    .section-spacer { height: 100vh; }
    
    /* Feature Blocks & Sequences */
    .feature-block, .feature-sequence {
        position: relative;
        min-height: 100vh;
        display: flex;
        align-items: center;
        width: 100%;
        max-width: 1400px; /* Increased max width to pull cards further out */
        margin: 0 auto;
        padding: 50px;
        box-sizing: border-box;
    }
    
    /* Cards */
    .content-card, .sticky-note {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(16px);
        padding: 40px;
        border-radius: 30px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        max-width: 400px; /* Reduced width to avoid overlap */
        pointer-events: auto;
        border: 1px solid rgba(255,255,255,0.5);
    }
    .content-card.right, .sticky-note.right { margin-right: 0; margin-left: auto; } /* Pushed to edges */
    .sticky-note.left { margin-right: auto; margin-left: 0; }

    /* Numbering */
    .with-number { position: relative; }
    .with-number::before {
        content: attr(data-step);
        position: absolute;
        top: -40px; right: 0;
        font-size: 5rem;
        font-weight: 900;
        color: rgba(0, 144, 146, 0.1);
        font-family: var(--font-en);
        line-height: 1;
        z-index: -1;
    }

    h2 { font-size: 2rem; font-weight: 800; color: var(--c-main-dark); margin-bottom: 20px; }
    p { font-size: 1.1rem; line-height: 1.6; color: #555; margin-bottom: 15px; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 12px; position: relative; padding-right: 25px; }
    li::before { content: '✓'; color: var(--c-main); position: absolute; right: 0; font-weight: bold; }
    
    /* Clean List for Sequence */
    .clean-list li { 
        padding-right: 0; opacity: 0.5; transition: opacity 0.3s; 
        font-weight: 600; cursor: pointer;
    }
    .clean-list li::before { content: none; }
    .clean-list li.active-item { opacity: 1; color: var(--c-main); transform: scale(1.05); }

    /* Triggers */
    .seq-trigger { height: 80vh; width: 100%; } /* Trigger space for each step */
    .feature-sequence { flex-direction: column; align-items: flex-start; }
    .sticky-note { position: sticky; top: 30vh; z-index: 20; }
    .feature-sequence .sticky-note { margin-bottom: 50vh; } /* Push trigger down? No, sticky stays */
    
    /* Layout Adjustments for specific sequences */
    #search-sequence { align-items: flex-start; } /* Left aligned text */
    #search-sequence .sticky-note { margin-right: auto; margin-left: 0; }
    
    #doctor-sequence { align-items: flex-end; } /* Right aligned text */
    #doctor-sequence .sticky-note { margin-left: auto; margin-right: 0; }

    #doctor-sequence { align-items: flex-end; } /* Right aligned text */
    #doctor-sequence .sticky-note { margin-left: auto; margin-right: 0; }

    #booking-sequence { align-items: flex-start; } /* Left aligned text */
    #booking-sequence .sticky-note { margin-right: auto; margin-left: 0; }

    #appointments-sequence { align-items: flex-end; } /* Right aligned text (Alternating) */
    #appointments-sequence .sticky-note { margin-left: auto; margin-right: 0; }

    #messages-sequence { align-items: flex-start; } /* Left aligned text */
    #messages-sequence .sticky-note { margin-right: auto; margin-left: 0; }

    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(10px); } }

    @media (max-width: 768px) {
        .content-card, .sticky-note {
            max-width: 90%; margin: 20px auto !important;
            padding: 25px;
            bottom: 50px;
            position: relative; /* Remove sticky on mobile for simplicity or adjust top */
        }
        /* Sticky fix for mobile sequences */
        .feature-sequence .sticky-note {
             position: sticky;
             top: auto; 
             bottom: 30px; /* Stick to bottom */
             z-index: 50;
             margin-bottom: 20px;
        }
        
        .feature-sequence { height: auto; display: block; }
        .seq-trigger { height: 60vh; }
    }
</style>
